<!-- الإصدار: 4 (لهذا الملف - إعادة الواجهة الكاملة كـ UserControl) -->
<!-- اسم الملف: SearchEditWindow.xaml -->
<!-- الوصف: واجهة المستخدم الكاملة للبحث عن المرضى وتعديل بياناتهم (كـ UserControl). -->
<UserControl x:Class="LABOGRA.Views.SearchEdit.SearchEditWindow"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:LABOGRA.Views.SearchEdit"
             mc:Ignorable="d"
             d:DesignHeight="700" d:DesignWidth="1050"
             FlowDirection="RightToLeft"
             Background="#EAF2FA">

    <UserControl.Resources>
        <!-- أنماط عامة -->
        <Style TargetType="TextBlock" x:Key="LabelStyle">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
            <Setter Property="FontSize" Value="14"/>
        </Style>
        <Style TargetType="TextBox" x:Key="InputTextBoxStyle">
            <Setter Property="Height" Value="28"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="5,0"/>
            <Setter Property="MinWidth" Value="180"/>
            <Setter Property="FontSize" Value="14"/>
        </Style>
        <Style TargetType="DatePicker" x:Key="InputDatePickerStyle">
            <Setter Property="Height" Value="28"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="5,0"/>
            <Setter Property="MinWidth" Value="150"/>
            <Setter Property="FontSize" Value="14"/>
        </Style>
        <Style TargetType="Button" x:Key="ActionButtonStyle">
            <Setter Property="Height" Value="35"/>
            <Setter Property="Padding" Value="15,0"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
        <Style TargetType="ComboBox" x:Key="InputComboBoxStyle">
            <Setter Property="Height" Value="28"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Padding" Value="5,0"/>
            <Setter Property="MinWidth" Value="120"/>
            <Setter Property="FontSize" Value="14"/>
        </Style>
        <!-- BooleanToVisibilityConverter يجب أن يكون معرفًا في App.xaml -->
    </UserControl.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- قسم معايير البحث -->
            <RowDefinition Height="Auto"/>
            <!-- زر البحث والفواصل -->
            <RowDefinition Height="*"/>
            <!-- جدول نتائج البحث -->
            <RowDefinition Height="Auto"/>
            <!-- قسم تعديل بيانات المريض المختار -->
            <RowDefinition Height="Auto"/>
            <!-- أزرار الحفظ والإلغاء -->
        </Grid.RowDefinitions>

        <!-- 1. قسم معايير البحث -->
        <Border Grid.Row="0" BorderBrush="#B0BEC5" BorderThickness="1" CornerRadius="5" Padding="15" Background="White">
            <StackPanel>
                <TextBlock Text="معايير البحث عن المرضى" FontSize="18" FontWeight="Bold" Foreground="#673AB7" Margin="0,0,0,15" HorizontalAlignment="Center"/>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- الصف الأول من معايير البحث -->
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="اسم المريض:" Style="{StaticResource LabelStyle}"/>
                    <TextBox Grid.Row="0" Grid.Column="1" Style="{StaticResource InputTextBoxStyle}" Margin="0,5,20,5"
                             Text="{Binding SearchPatientName, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="0" Grid.Column="2" Text="الرقم الطبي:" Style="{StaticResource LabelStyle}"/>
                    <TextBox Grid.Row="0" Grid.Column="3" Style="{StaticResource InputTextBoxStyle}" Margin="0,5,20,5"
                             Text="{Binding SearchMedicalRecordNumber, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="0" Grid.Column="4" Text="رقم الهاتف:" Style="{StaticResource LabelStyle}"/>
                    <TextBox Grid.Row="0" Grid.Column="5" Style="{StaticResource InputTextBoxStyle}" Margin="0,5,0,5"
                             Text="{Binding SearchPhoneNumber, UpdateSourceTrigger=PropertyChanged}"/>

                    <!-- الصف الثاني من معايير البحث -->
                    <TextBlock Grid.Row="1" Grid.Column="0" Text="تاريخ التسجيل من:" Style="{StaticResource LabelStyle}" Margin="0,10,8,0"/>
                    <DatePicker Grid.Row="1" Grid.Column="1" Style="{StaticResource InputDatePickerStyle}" Margin="0,10,20,5"
                                SelectedDate="{Binding SearchRegistrationDateFrom, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="1" Grid.Column="2" Text="إلى تاريخ:" Style="{StaticResource LabelStyle}" Margin="0,10,8,0"/>
                    <DatePicker Grid.Row="1" Grid.Column="3" Style="{StaticResource InputDatePickerStyle}" Margin="0,10,20,5"
                                SelectedDate="{Binding SearchRegistrationDateTo, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="1" Grid.Column="4" Text="الطبيب المحول:" Style="{StaticResource LabelStyle}" Margin="0,10,8,0"/>
                    <TextBox Grid.Row="1" Grid.Column="5" Style="{StaticResource InputTextBoxStyle}" Margin="0,10,0,5"
                             Text="{Binding SearchReferringPhysicianName, UpdateSourceTrigger=PropertyChanged}"/>
                </Grid>
            </StackPanel>
        </Border>

        <!-- 2. زر البحث والفواصل -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,10">
            <Button Content="🔎 بـحــث" Command="{Binding SearchCommand}" Style="{StaticResource ActionButtonStyle}" Background="#2196F3" MinWidth="150"/>
            <Button Content="مسح المعايير" Command="{Binding ClearSearchCommand}" Style="{StaticResource ActionButtonStyle}" Background="#78909C" MinWidth="150"/>
        </StackPanel>

        <!-- 3. جدول نتائج البحث -->
        <Border Grid.Row="2" BorderBrush="#B0BEC5" BorderThickness="1" CornerRadius="5" Padding="5" Background="White">
            <DataGrid ItemsSource="{Binding SearchResults}"
                      SelectedItem="{Binding SelectedPatientFromSearch, Mode=TwoWay}"
                      AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False"
                      HeadersVisibility="Column" FontSize="13" RowHeight="28" AlternationCount="2"
                      ScrollViewer.CanContentScroll="True" 
                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                      ScrollViewer.HorizontalScrollBarVisibility="Auto">
                <DataGrid.Resources>
                    <Style TargetType="DataGridColumnHeader">
                        <Setter Property="FontWeight" Value="Bold"/>
                        <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        <Setter Property="Padding" Value="8,5"/>
                        <Setter Property="Background" Value="#ECEFF1"/>
                    </Style>
                    <Style TargetType="DataGridCell">
                        <Setter Property="Padding" Value="8,3"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="{x:Type DataGridCell}">
                                    <Border Padding="{TemplateBinding Padding}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" Background="{TemplateBinding Background}" SnapsToDevicePixels="True">
                                        <ContentPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                    <Style TargetType="DataGridRow">
                        <Style.Triggers>
                            <Trigger Property="AlternationIndex" Value="1">
                                <Setter Property="Background" Value="#F5F5F5" />
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="#BBDEFB"/>
                                <Setter Property="Foreground" Value="Black"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.Resources>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="الكود" Binding="{Binding Id}" Width="70"/>
                    <DataGridTextColumn Header="اسم المريض" Binding="{Binding Name}" Width="2*"/>
                    <DataGridTextColumn Header="الرقم الطبي" Binding="{Binding MedicalRecordNumber}" Width="1.2*"/>
                    <DataGridTextColumn Header="رقم الهاتف" Binding="{Binding PhoneNumber}" Width="1.2*"/>
                    <DataGridTextColumn Header="تاريخ التسجيل" Binding="{Binding RegistrationDateTime, StringFormat='yyyy-MM-dd HH:mm'}" Width="1.5*"/>
                    <DataGridTextColumn Header="الطبيب المحول" Binding="{Binding ReferringPhysician.Name}" Width="1.5*"/>
                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <!-- 4. قسم تعديل بيانات المريض المختار -->
        <Border Grid.Row="3" BorderBrush="#B0BEC5" BorderThickness="1" CornerRadius="5" Padding="15" Margin="0,10,0,0" Background="White"
                Visibility="{Binding IsPatientSelectedForEdit, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel>
                <TextBlock Text="تعديل بيانات المريض المحدد" FontSize="18" FontWeight="Bold" Foreground="#4CAF50" Margin="0,0,0,15" HorizontalAlignment="Center"/>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- اللقب والاسم -->
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="اللقب:" Style="{StaticResource LabelStyle}"/>
                    <ComboBox Grid.Row="0" Grid.Column="1" Style="{StaticResource InputComboBoxStyle}" Margin="0,5,20,5"
                              ItemsSource="{Binding Titles}" 
                              SelectedItem="{Binding EditablePatient.Title, Mode=TwoWay}"/>

                    <TextBlock Grid.Row="0" Grid.Column="2" Text="الاسم:" Style="{StaticResource LabelStyle}"/>
                    <TextBox Grid.Row="0" Grid.Column="3" Style="{StaticResource InputTextBoxStyle}" Margin="0,5,0,5"
                             Text="{Binding EditablePatient.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                    <!-- الرقم الطبي والبريد الإلكتروني -->
                    <TextBlock Grid.Row="1" Grid.Column="0" Text="الرقم الطبي:" Style="{StaticResource LabelStyle}"/>
                    <TextBox Grid.Row="1" Grid.Column="1" Style="{StaticResource InputTextBoxStyle}" Margin="0,5,20,5"
                             Text="{Binding EditablePatient.MedicalRecordNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="1" Grid.Column="2" Text="البريد الإلكتروني:" Style="{StaticResource LabelStyle}"/>
                    <TextBox Grid.Row="1" Grid.Column="3" Style="{StaticResource InputTextBoxStyle}" Margin="0,5,0,5"
                             Text="{Binding EditablePatient.Email, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                    <!-- النوع والعمر -->
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="النوع:" Style="{StaticResource LabelStyle}"/>
                    <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Margin="0,5,20,5">
                        <RadioButton Content="ذكر" GroupName="EditGenderGroup" VerticalAlignment="Center" Margin="0,0,10,0" FontSize="14"
                                     IsChecked="{Binding IsEditablePatientMale, Mode=TwoWay}"/>
                        <RadioButton Content="أنثى" GroupName="EditGenderGroup" VerticalAlignment="Center" FontSize="14"
                                     IsChecked="{Binding IsEditablePatientFemale, Mode=TwoWay}"/>
                    </StackPanel>

                    <TextBlock Grid.Row="2" Grid.Column="2" Text="العمر:" Style="{StaticResource LabelStyle}"/>
                    <StackPanel Grid.Row="2" Grid.Column="3" Orientation="Horizontal" Margin="0,5,0,5">
                        <TextBox Width="80" Style="{StaticResource InputTextBoxStyle}" Margin="0,0,5,0"
                                 Text="{Binding EditablePatient.AgeValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        <ComboBox Style="{StaticResource InputComboBoxStyle}" MinWidth="100"
                                  ItemsSource="{Binding AgeUnits}" 
                                  SelectedItem="{Binding EditablePatient.AgeUnit, Mode=TwoWay}"/>
                    </StackPanel>

                    <!-- رقم الهاتف والطبيب المحول -->
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="رقم الهاتف:" Style="{StaticResource LabelStyle}"/>
                    <TextBox Grid.Row="3" Grid.Column="1" Style="{StaticResource InputTextBoxStyle}" Margin="0,5,20,5"
                             Text="{Binding EditablePatient.PhoneNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Grid.Row="3" Grid.Column="2" Text="الطبيب المحول:" Style="{StaticResource LabelStyle}"/>
                    <ComboBox Grid.Row="3" Grid.Column="3" Style="{StaticResource InputComboBoxStyle}" IsEditable="True" Margin="0,5,0,5"
                              ItemsSource="{Binding ReferringPhysicians}" DisplayMemberPath="Name"
                              SelectedItem="{Binding SelectedEditableReferringPhysician, Mode=TwoWay}"
                              Text="{Binding EditablePatient.ReferringPhysician.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                    <!-- العنوان -->
                    <TextBlock Grid.Row="4" Grid.Column="0" Text="العنوان:" Style="{StaticResource LabelStyle}"/>
                    <TextBox Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="3" Style="{StaticResource InputTextBoxStyle}" Margin="0,5,0,5" Height="Auto" MinHeight="28" MaxHeight="80" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"
                             Text="{Binding EditablePatient.Address, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                </Grid>
            </StackPanel>
        </Border>

        <!-- 5. أزرار الحفظ والإلغاء لمنطقة التعديل -->
        <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,15,0,0"
                    Visibility="{Binding IsPatientSelectedForEdit, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Button Content="💾 حفظ التعديلات" Command="{Binding SaveChangesCommand}" Style="{StaticResource ActionButtonStyle}" Background="#4CAF50" MinWidth="180"/>
            <Button Content="إلغاء التعديل" Command="{Binding CancelEditCommand}" Style="{StaticResource ActionButtonStyle}" Background="#F44336" MinWidth="180"/>
        </StackPanel>

    </Grid>
</UserControl>