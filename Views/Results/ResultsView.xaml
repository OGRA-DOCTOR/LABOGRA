<!-- الإصدار: 7 -->
<!-- اسم الملف: LABOGRA/Views/Results/ResultsView.xaml -->
<!-- تاريخ التحديث: 2023-10-30 -->
<!-- الوصف:
    1. تصحيح الخطأ XDG-0007: The resource "DarkTextBrush" has an incompatible type.
       وذلك بتعديل كيفية تعيين اللون لـ SelectedItemTextBrush.
    2. الحفاظ على جميع التحسينات السابقة.
-->
<UserControl x:Class="LABOGRA.Views.Results.ResultsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:LABOGRA.Views.Results"
             xmlns:viewmodels="clr-namespace:LABOGRA.ViewModels" 
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance Type=viewmodels:ResultsViewModel, IsDesignTimeCreatable=False}" 
             d:DesignHeight="700" d:DesignWidth="1000" 
             Background="#EAF2FA"
             FlowDirection="RightToLeft"
             Loaded="ResultsView_Loaded">

    <UserControl.Resources>
        <!-- تعريف الألوان الأساسية -->
        <SolidColorBrush x:Key="PrimaryBlueBrush" Color="#1E90FF"/>
        <SolidColorBrush x:Key="PrimaryOrangeBrush" Color="#FF4500"/>
        <SolidColorBrush x:Key="SuccessGreenBrush" Color="ForestGreen"/>
        <SolidColorBrush x:Key="UnitTextBrushColor" Color="ForestGreen"/>
        <SolidColorBrush x:Key="ReferenceRangeTextBrushColor" Color="MediumPurple"/>

        <SolidColorBrush x:Key="LightBlueBackgroundBrush" Color="#D6EAF8"/>
        <SolidColorBrush x:Key="DarkTextBrush" Color="#2C3E50"/>
        <SolidColorBrush x:Key="HeaderTextBrush" Color="White"/>
        <SolidColorBrush x:Key="ListItemAlternateBackgroundBrush" Color="#F0F8FF"/>
        <SolidColorBrush x:Key="BorderBrush" Color="#A9CCE3"/>
        <SolidColorBrush x:Key="SelectedItemBackgroundBrush" Color="#AED6F1"/>

        <!-- تصحيح تعريف SelectedItemTextBrush -->
        <SolidColorBrush x:Key="SelectedItemTextBrush" Color="{Binding Source={StaticResource DarkTextBrush}, Path=Color}"/>

        <!-- أنماط الخطوط والأدوات (كما هي في الإصدار 6) -->
        <Style TargetType="TextBlock" x:Key="LargeLabelTextStyle">
            <Setter Property="FontSize" Value="18"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource DarkTextBrush}"/>
        </Style>
        <Style TargetType="ComboBox" x:Key="LargeComboBoxStyle">
            <Setter Property="FontSize" Value="17"/>
            <Setter Property="MinWidth" Value="380"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="Padding" Value="6"/>
        </Style>

        <Style x:Key="BaseHeaderStyle" TargetType="GridViewColumnHeader">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource HeaderTextBrush}"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="HorizontalContentAlignment" Value="Center"/>
        </Style>
        <Style x:Key="TestNameHeaderStyle" TargetType="GridViewColumnHeader" BasedOn="{StaticResource BaseHeaderStyle}">
            <Setter Property="Background" Value="{StaticResource PrimaryBlueBrush}"/>
        </Style>
        <Style x:Key="ResultHeaderStyle" TargetType="GridViewColumnHeader" BasedOn="{StaticResource BaseHeaderStyle}">
            <Setter Property="Background" Value="{StaticResource PrimaryOrangeBrush}"/>
        </Style>
        <Style x:Key="UnitHeaderStyle" TargetType="GridViewColumnHeader" BasedOn="{StaticResource BaseHeaderStyle}">
            <Setter Property="Background" Value="{StaticResource UnitTextBrushColor}"/>
        </Style>
        <Style x:Key="ReferenceRangeHeaderStyle" TargetType="GridViewColumnHeader" BasedOn="{StaticResource BaseHeaderStyle}">
            <Setter Property="Background" Value="{StaticResource ReferenceRangeTextBrushColor}"/>
        </Style>
        <Style x:Key="SaveHeaderStyle" TargetType="GridViewColumnHeader" BasedOn="{StaticResource BaseHeaderStyle}">
            <Setter Property="Background" Value="{StaticResource PrimaryOrangeBrush}"/>
        </Style>

        <Style TargetType="TextBlock" x:Key="ListItemTextStyle">
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Foreground" Value="{StaticResource DarkTextBrush}"/>
        </Style>
        <Style TargetType="TextBox" x:Key="ListItemTextBoxStyle">
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="MinWidth" Value="130"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="Padding" Value="6"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>

        <Style TargetType="Button" x:Key="SaveButtonStyle">
            <Setter Property="Padding" Value="12,7"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="MinWidth" Value="75"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="buttonBorder" 
                                Background="{StaticResource PrimaryOrangeBrush}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <DataTrigger Binding="{Binding IsSavedSuccessfully}" Value="True">
                                <Setter TargetName="buttonBorder" Property="Background" Value="{StaticResource SuccessGreenBrush}"/>
                            </DataTrigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="buttonBorder" Property="Opacity" Value="0.9"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="buttonBorder" Property="Opacity" Value="0.7"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="buttonBorder" Property="Background" Value="LightGray"/>
                                <Setter Property="Foreground" Value="DarkGray"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect ShadowDepth="2" BlurRadius="4" Opacity="0.3" Color="Black"/>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <UserControl.DataContext>
        <viewmodels:ResultsViewModel/>
    </UserControl.DataContext>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="تسجيل النتائج" FontSize="30" FontWeight="ExtraBold" 
                   Foreground="{StaticResource PrimaryBlueBrush}" 
                   HorizontalAlignment="Center" Margin="0,0,0,25"/>

        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,20" HorizontalAlignment="Right">
            <ComboBox ItemsSource="{Binding PatientList}" 
                      SelectedItem="{Binding SelectedPatient}"
                      DisplayMemberPath="Name" 
                      Style="{StaticResource LargeComboBoxStyle}"
                      IsEnabled="{Binding IsPatientSelectionEnabled}" FlowDirection="RightToLeft">
                <ComboBox.ToolTip>
                    <TextBlock Text="اختر المريض لعرض تحاليله وإدخال النتائج"/>
                </ComboBox.ToolTip>
            </ComboBox>
            <TextBlock Text=":اختر المريض" VerticalAlignment="Center" Margin="0,0,10,0" Style="{StaticResource LargeLabelTextStyle}"/>
        </StackPanel>

        <Border Grid.Row="2" BorderBrush="{StaticResource PrimaryBlueBrush}" BorderThickness="2" CornerRadius="8" Padding="1" Background="White">
            <ListView x:Name="ResultsListView" 
                      ItemsSource="{Binding LabOrderItems}" 
                      HorizontalContentAlignment="Stretch" 
                      FlowDirection="LeftToRight" 
                      AlternationCount="2"
                      ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                      PreviewKeyDown="ResultsListView_PreviewKeyDown">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Padding" Value="5,10"/>
                        <Setter Property="BorderThickness" Value="0,0,0,1"/>
                        <Setter Property="BorderBrush" Value="{StaticResource LightBlueBackgroundBrush}"/>
                        <Style.Triggers>
                            <Trigger Property="ItemsControl.AlternationIndex" Value="1">
                                <Setter Property="Background" Value="{StaticResource ListItemAlternateBackgroundBrush}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{StaticResource LightBlueBackgroundBrush}"/>
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{StaticResource SelectedItemBackgroundBrush}"/>
                                <!-- السطر التالي معلق للحفاظ على ألوان النصوص الفردية. يمكن تفعيله إذا أردت لون نص موحد للصف المحدد -->
                                <!-- <Setter Property="Foreground" Value="{StaticResource SelectedItemTextBrush}"/> -->
                                <Setter Property="BorderBrush" Value="{StaticResource PrimaryBlueBrush}"/>
                                <Setter Property="BorderThickness" Value="0,0,0,1.5"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.View>
                    <GridView AllowsColumnReorder="False">
                        <GridViewColumn Header="Test Name" Width="300" HeaderContainerStyle="{StaticResource TestNameHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock TextWrapping="Wrap" Style="{StaticResource ListItemTextStyle}" 
                                               Foreground="{StaticResource PrimaryBlueBrush}"> 
                                          <Run Text="{Binding TestName, Mode=OneWay}" FontWeight="Bold"/>
                                          <Run Text="{Binding TestAbbreviation, Mode=OneWay, StringFormat= ({0})}" Foreground="DarkSlateGray"/>
                                    </TextBlock>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <GridViewColumn Header="Result" Width="190" HeaderContainerStyle="{StaticResource ResultHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBox x:Name="ResultTextBox" 
                                             Text="{Binding ResultValue, UpdateSourceTrigger=PropertyChanged}" 
                                             Style="{StaticResource ListItemTextBoxStyle}"
                                             Foreground="{StaticResource PrimaryOrangeBrush}"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <GridViewColumn Header="Unit" Width="120" HeaderContainerStyle="{StaticResource UnitHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Unit, Mode=OneWay}" Style="{StaticResource ListItemTextStyle}"
                                               Foreground="{StaticResource UnitTextBrushColor}" FontWeight="SemiBold"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <GridViewColumn Header="Reference Range" Width="230" HeaderContainerStyle="{StaticResource ReferenceRangeHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DisplayReferenceRange, Mode=OneWay}" TextWrapping="Wrap" Style="{StaticResource ListItemTextStyle}"
                                               Foreground="{StaticResource ReferenceRangeTextBrushColor}" FontWeight="SemiBold"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>

                        <GridViewColumn Header="Save" Width="110" HeaderContainerStyle="{StaticResource SaveHeaderStyle}">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="Save" 
                                            Command="{Binding SaveResultCommand}" 
                                            Style="{StaticResource SaveButtonStyle}"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>
                    </GridView>
                </ListView.View>
            </ListView>
        </Border>
    </Grid>
</UserControl>